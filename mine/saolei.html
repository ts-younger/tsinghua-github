<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>扫雷游戏开发</title>
	<link rel="stylesheet" href="mine.css">
</head>
<body>
	<div id="app">
		<div id="control">
			<div class="mine-score">
				<span></span>
			</div>
			<div class="mine-btn">
				<button id='mine-start' class="start"></button>
			</div>
			<div class="mine-time">
				
			</div>
		</div>
		<div class="mine-cont">

			<canvas id="mine" width="400" height="400"></canvas>		
		</div>
	</div>
	<script>
	var oDiv = document.getElementById('app');
	var can = document.getElementById('mine');
	var ctx = can.getContext('2d');
	var obtn = document.getElementById('mine-start');


// keydown 左键 =>  判断是否为地雷 => 是,结束游戏 => 否,判断周边地雷数量 => 数量为0,继续寻找周边地雷 => 不为0,显示数字
	//  keydown 右键 =>  次数为1: 标记地雷 => 次数为2:标记问号 => 复原
can.oncontextmenu = function (){
	return false
}
function Mine () {
	
}
var mine = {
	that: this,
	map: [],
	mine: [],
	num: 0,
	life: false,

	changeCode: function(num) {
		return Math.floor(num / 20)
	},
	init: function () {	
		this.num = 0;
		this.life = true;
		for(let i = 0; i < 20; i++) {
			this.map[i] = [];
			for(let j =0; j<20; j++) {
				this.map[i][j] = ['blank', 0, 'blank', 0]
				// this.mine[ij] = ['blank', 0, 'blank']
				let img = document.createElement('img');
				this.drawimage('./img/blank.bmp', i* 20, j *20)
			}
		}

		this.random()
	},
	random: function () {
		var len = 33;
		this.mine = [];
		while (len) {
			let x = Math.floor(Math.random()* 20)
			let y = Math.floor(Math.random()* 20)
			if(this.map[x][y][1] == 1) continue;
			this.map[x][y][1] = 1;
			this.mine.push([x, y])
			len--
		}		
	},
	drawimage: function(url, x, y){
		let img = document.createElement('img');
		img.src = url;
		img.onload = function() {
			ctx.drawImage( img, x, y, 20, 20)
		}
	},
	failedDiv: function () {
		let arrFlag = [];
		let arrMine = [];
		for(let i = 0; i < this.map.length; i++) {
			for(let j = 0; j <this.map[i].length; j++) {
				if(this.map[i][j][2] == 'flag'){
					arrFlag.push([i, j])
				}
				if(this.map[i][j][1] == 1){
					this.drawimage( './img/mine.bmp', i * 20, j * 20)
				}
			}
		}

		arrFlag.forEach( value => {
			let res = this.mine.findIndex( function (item) {
				return value[0] == item[0] && value[1] == item[1]
			})
			if(res == -1){
				this.drawimage('./img/error.bmp', value[0] * 20, value[1]*20)
			}
		})
		this.life =false

	},
	showError: function() {
		let arr = [];

	},
	cancelRight: function () {
		return false
	},
	checkMine: function (left, top) {
		if(this.map[left][top][1] == 1){
			this.map[left][top][3] = 1
			return true
		}
	},
	checkMap: function (left, top){
		let count = 0;
		let array = [
			[left-1, top-1],[left-1, top],[left-1, top+1],[left, top-1],
			[left, top+1],[left+1, top-1],[left+1, top],[left+1, top+1]
		];
		array = array.filter( function (value) {
			return value[0] >=0 && value[1] >=0 &&
			value[0] < 20 && value[1] <20
		})

		array.forEach( value => {
			if(this.map[value[0]][value[1]][1] == 1) {
				count++
			}
		})
			this.num+=1;
			console.log(left, top)
		if(count){
			let url = `./img/${count}.bmp`;		
			this.map[left][top][0] = count;
			this.map[left][top][3] = 1;
			this.drawimage(url, left* 20, top * 20)
		}else {
			console.log('zero')
			this.map[left][top][0] = 0;
			this.map[left][top][3] = 1;
			this.drawimage('./img/0.bmp', left* 20, top * 20)
			array.forEach( item => {
				if(this.map[item[0]][item[1]][0] != 'blank') return;
				this.checkMap(item[0], item[1])
			})
		}
		console.log(this.num)
		if(this.num == 374) {
			alert('you win')
		}
	},
	checkscucce: function() {
		for(let i = 0; i < this.map.length; i++) {
			for(let j = 0; j< this.map[i].length; j++) {
				if(this.map[i][j][0] == 'blank') {
					if(this.map[i][j][1] != 1) {
						return false
					}else {
						this.life = false;
						alert('you win')
					}
				}
			}
		}
	},

}
mine.init()

can.onmousedown = function(ev) {
	if(!mine.life) return; 
	let e = ev || window.event;
	let x =mine.changeCode(e.layerX);
	let y = mine.changeCode(e.layerY);
	if(mine.map[x][y][3] == 1){ return false}
	if(ev.button == 2) {
		switch (mine.map[x][y][2]) {
			case 'blank':
			mine.map[x][y][2] = 'flag';
			mine.drawimage('./img/flag.bmp', x* 20, y*20);
			mine.map[x][y][3] = 1;

			break;
			case 'flag':
			mine.map[x][y][2] = 'ask';
			mine.drawimage('./img/ask.bmp', x* 20, y*20)
			break;
			case 'ask':
			mine.map[x][y][2] = 'blank';
			mine.drawimage('./img/blank.bmp', x* 20, y*20);
			mine.map[x][y][3] = 0;

		}
	}else if( ev.button == 0) {		
		if(mine.checkMine(x, y)){
			mine.failedDiv();
			obtn.setAttribute('class', 'failed')
			mine.drawimage('./img/blood.bmp', x* 20, y*20)
			// can.removeEventListener('mousemove', )
			return
		}else {
			mine.checkMap(x, y)
		}		
	}
	console.log(mine.map[x][y])
}
obtn.onclick = function() {
	this.className = 'start';
	mine.init()
}
var ox,
	oy;
can.onmouseover = function(ev){
	let e = ev || window.event;
	
	can.onmousemove = function (ev) {
		if(!mine.life) return; 

		let e = ev || window.event;
		let x = mine.changeCode(e.layerX);
		let y = mine.changeCode(e.layerY);
		
		if(ox>=0 && mine.map[ox][oy][3] == 0){
			mine.drawimage('./img/blank.bmp', ox *20, oy* 20)
		}
		if(mine.map[x][y][3] == 0) {
			
			ox =x;
			oy = y;
			mine.drawimage('./img/0.bmp', ox *20, oy* 20);							

		}
	}
}
can.onmouseout = function() {
	if(ox>=0 && mine.map[ox][oy][3] == 0){
		mine.drawimage('./img/blank.bmp', ox *20, oy* 20)
	}

	// can.onmousemove = null;
}
	</script>
</body>
</html>